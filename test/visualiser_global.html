<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

    <script type="text/javascript" src="../lib/voronoi/point2d.js"></script>
    <script type="text/javascript" src="../lib/voronoi/segment.js"></script>
    <script type="text/javascript" src="../lib/voronoi/line2d.js"></script>
    <script type="text/javascript" src="../lib/rhill-voronoi-core-min.js"></script>
    <script type="text/javascript" src="../lib/common/logger.js"></script>
    <script type="text/javascript" src="../lib/voronoi/vast_voro.js"></script>
    <script type="text/javascript" src="../lib/visualiser_global.js"></script>
    <script src="../lib/net/socket.io.js"></script>


    <script type="text/javascript">
        var Visualiser = {
            visualiser : new VisualiserGlobal(),
            voronoi: new VAST_Voronoi(),
            gateway: {host: "10.110.117.14", port: 37700},
            aoi  : {x: 0, y: 0, aoi: 10},
            sites: [],
            matchers: [],
            clients: [],
            boundary:[],
            colors: ['#0f0','#f00','#00f', '#880', '#f0f', '#0ff','#000'],
            halt: undefined,
            diagram: null,
            margin: 50,
            canvas: null,
            bbox: {xl:0,xr:1000,yt:0,yb:1000},

            init: function() {
                sites = [];
                matchers= [];
                clients= [];
                boundary=[];

                this.canvas = document.getElementById("voronoiCanvas");
                console.log("init");
                this.voronoi.set_bounding_box(this.bbox);
                this.setID();

                this.visualiser.init(function(client_data, id) {
                    //console.log(client_data);
                    this.sites[id] = client_data;

                    Visualiser.recalculate();
                }, function(site_data) {
                    this.sites = site_data;

                    Visualiser.recalculate();
                }, function (id, matcher, clients, boundary) {
                    delete this.matchers[id];
                    this.matchers[id] = matcher;
                    delete this.clients[id];
                    this.clients[id] = clients;
                    delete this.boundary[id];
                    this.boundary[id] = boundary;

                    Visualiser.recalculate();
                }, function (id) {
                    console.log("Deleting client with id " + id);
                    console.log(this.clients);
                    delete this.clients[id];
                });
            },

            initVoro: function() {
                //console.log("Sites in initVoro");
                //console.log(sites);
                this.recalculate();
            },

            setID: function() {
                this.visualiser.set_onID(function(id) {
                    _id = id;
                    document.getElementById("selected").innerHTML = _id;
                });
            },

            appendList: function(data){
                var node = document.createElement("LI");
                var sender = data.msg.aid != undefined ? data.msg.aid : data.sender;
                var textnode = document.createTextNode("["+sender+"] "+data.name+" to targets "+data.targets);

                node.appendChild(textnode);
                document.getElementById(data.direction).appendChild(node);
            },

            recalculate: function() {
                //console.log("recalculate sites:");
                //console.log(sites);
                if (document.getElementById('VON').checked) {
                    this.sites2voro();
                } else if (document.getElementById('VSO').checked) {
                    this.matchers2voro();
                }
                //console.log("after sites2voro:");
                //console.log(sites);
                this.diagram = this.voronoi.get_result();
                //console.log("after get_result:");
                //console.log(sites);
                this.updateStats();
                this.render();
            },

            sites2voro: function() {
                this.voronoi.clear();
                for (var key in sites) {
                    //console.log(sites[key]);
                    this.voronoi.insert(key,sites[key]);
                }
            },

            matchers2voro: function() {
                this.voronoi.clear();
                for (var key in matchers) {
                    this.voronoi.insert(key,matchers[key]);
                }
            },

            updateDiagram: function(){
                this.voronoi.set_bounding_box(this.bbox);
                this.diagram = this.voronoi.get_result();
            },

            updateStats: function(){
                if (!this.diagram) {return;}
                var e = document.getElementById('voronoiStats');
                if (!e) {return;}
        		e.innerHTML = '('+this.diagram.cells.length+' Voronoi cells computed from '+Object.keys(sites).length+' Voronoi sites in '+this.diagram.execTime+' ms &ndash; rendering <i>not</i> included)';
            },

            move: function() {
                console.log("Start move");
                //this.visualiser.move();
            },

            startReplay: function(filename) {
                console.log("Starting replay");
                this.visualiser.startReplay(filename+".txt");
            },

            analyse: function(filename) {
                this.visualiser.analyse(filename);
            },

            render: function() {
                var ctx = this.canvas.getContext('2d');

                //clear sites and neighbours list
                var site_list = document.getElementById("sites");
                var neighbour_list = document.getElementById("neighbours");
                var client_count = document.getElementById("clients");

                site_list.innerHTML = "";
                neighbour_list.innerHTML = "";
                client_count.innerHTML = "";

                //background
                ctx.globalAlpha = 1;
                ctx.beginPath();
                ctx.rect(0,0,this.canvas.width,this.canvas.height);
        		ctx.fillStyle = 'white';
        		ctx.fill();
        		ctx.strokeStyle = '#888';
                ctx.setLineDash([]);
                ctx.lineWidth = 1;
        		ctx.stroke();

        		// voronoi
                if (!this.diagram) {return;}

        		// edges
        		ctx.beginPath();
        		ctx.strokeStyle='#000';

        		var edges = this.diagram.edges,
        			iEdge = edges.length,
        			edge, v;
        		while (iEdge--) {
        			edge = edges[iEdge];
        			v = edge.va;
        			ctx.moveTo(v.x,v.y);
        			v = edge.vb;
        			ctx.lineTo(v.x,v.y);
        			}
        		ctx.stroke();



                if (document.getElementById("VON").checked) {// sites
        		          ctx.beginPath();
                          ctx.fillStyle = '#44f';
                          ctx.font = "15px Verdana";
                    for (var key in sites) {
                    v = sites[key];
                    if (v == undefined) {
                        delete sites[key]
                        continue;
                    }
                    var idx = v.id;

                    ctx.rect(v.x,v.y,4,4);
                    ctx.fillText(idx, v.x+7,v.y+7);

                    // add site to info on right
                    var node = document.createElement("LI");
                    var textnode = document.createTextNode("["+idx+"] Site: ("+Math.round(v.x)+","+Math.round(v.y)+") voronoiID: "+v.voronoiId);

                    node.appendChild(textnode);
                    site_list.appendChild(node);
                    ctx.fill();
                    }
                } else {
                    for (var key in matchers) {
                    v = matchers[key];
                    if (v == undefined) {
                        delete matchers[key]
                        continue;
                    }
                    var idx = v.id;
                    var mod = idx%7;

                    ctx.beginPath();
                    ctx.font = "15px Verdana";
                    ctx.fillStyle = this.colors[mod];
                    ctx.strokeStyle = this.colors[mod];
                    ctx.rect(v.x,v.y,4,4);
                    ctx.fillText(idx, v.x+7,v.y+7);

                    // add site to info on right
                    var node = document.createElement("LI");
                    var textnode = document.createTextNode("["+idx+"] Site: ("+Math.round(v.x)+","+Math.round(v.y)+") voronoiID: "+v.voronoiId);

                    node.appendChild(textnode);
                    site_list.appendChild(node);

                    ctx.closePath();
                    ctx.fill();

                    // edges
            		ctx.beginPath();
            		ctx.strokeStyle=this.colors[mod];
                    ctx.setLineDash([5,3]);

                    if (!boundary.hasOwnProperty(key))
                        continue;

            		var iEdge = boundary[key].length,
            			edge, v;
            		while (iEdge--) {
            			edge = boundary[key][iEdge];
            			v = edge.p1;
                        console.log()
            			ctx.moveTo(v.x,v.y);
            			v = edge.p2;
            			ctx.lineTo(v.x,v.y);
            			}
            		ctx.stroke();
                    }

                    for (var key in clients) {
                        v = clients[key];
                        if (v == undefined) {
                            delete clients[key]
                            continue;
                        }

                        var length = Object.keys(clients[key]).length == 0 ? 0 : Object.keys(clients[key]).length;

                        node = document.createElement("LI");
                        textnode = document.createTextNode("["+key+"]: " + length);

                        node.appendChild(textnode);
                        client_count.appendChild(node);

                        for (var keys in v) {
                            var c = v[keys];
                            var idy = c.id;

                            var mod = key%7;

                            ctx.beginPath();
                            ctx.font = "15px Verdana";
                            ctx.fillStyle = this.colors[mod];
                            ctx.rect(c.aoi.center.x,c.aoi.center.y,4,4);
                            if (c.aoi.center.x > 970 && c.aoi.center.y > 30) {
                                ctx.fillText(idy, c.aoi.center.x-15,c.aoi.center.y+15);
                            } else if (c.aoi.center.x < 970 && c.aoi.center.y < 30) {
                                ctx.fillText(idy, c.aoi.center.x+15,c.aoi.center.y-15);
                            } else if (c.aoi.center.x > 970 && c.aoi.center.y < 30) {
                                ctx.fillText(idy, c.aoi.center.x-15,c.aoi.center.y-15);
                            } else if (c.aoi.center.x < 970 && c.aoi.center.y > 30) {
                                ctx.fillText(idy, c.aoi.center.x+15,c.aoi.center.y+15);
                            }

                            ctx.closePath();
                            ctx.fill();

                            ctx.beginPath();
                            ctx.strokeStyle = this.colors[mod];
                            ctx.setLineDash([]);
                            ctx.lineWidth = 2;
                            ctx.arc(c.aoi.center.x, c.aoi.center.y, 100, 0, Math.PI*2, true);
                            ctx.closePath();
                            ctx.stroke();

                            // add site to info on right
                            var node = document.createElement("LI");
                            var textnode = document.createTextNode("["+idy+"] Site: ("+Math.round(c.aoi.center.x)+","+Math.round(c.aoi.center.y)+")");

                            node.appendChild(textnode);
                            neighbour_list.appendChild(node);

                        }
                    }
                }
            },

            getVoro: function() {
                return this.voronoi;
            }
        };
    </script>
</head>

<body onload="Visualiser.init();">
    <table width="100%" border=0>
        <tr>
            <td>
                <h1>VAST global visualiser</h1>
                <input type="text" value="test" id="filename"/><input type="button" value="Start Replay" onclick="Visualiser.startReplay(document.getElementById('filename').value);"/>
                <input type="button" value="Analyse" onclick="Visualiser.analyse(document.getElementById('filename').value);"/>
                <input type="button" value="Reconnect" onclick="Visualiser.init();"/>
                <input type="button" value="Start Movement" onclick="Visualiser.move();"/>
            </td>
            <td>
                <form id="disp_form">
                Display Type:
                <input type="radio" id="VON" name="disp_type" value="VON_peers"/>VON &nbsp &nbsp
                <input type="radio" id="VSO" name="disp_type" value="VSO_peers"  checked="true"/> VSO
                </form>
            </td>
        </tr>
        <tr max-height="840px">
            <td width = "50%">
                <h4 class="divhdr">Canvas <span id="voronoiStats" style="font:normal 11px sans"></span></h4>
                <div id="canvasParent">
                    <noscript>You need to enable Javascript in your browser for this page to display properly.</noscript>
                    <canvas id="voronoiCanvas" width="1000" height="1000" onclick=""></canvas>
                </div>
            </td>
            <td width = "25%" valign="top">
                <h2 style="text-align:center; font-size: 30px;">Site Stats</br></h2>
                    <h4>Sites</h4>
                        <nav  style="overflow-y:scroll; max-height:500px;">
                            <ul id="sites" style="text-align:left;"></ul>
                        </nav>
                <h2 style="text-align:bottom; font-size: 30px;"> Client count</br></h2>
                <h4>Matchers</h4>
                    <nav style="overflow-y:scroll; max-height:500px">
                        <ul id="clients" style="text-align:left;"></ul>
                    </nav>
            </td>
            <td width = "25%" valign="top">
                <h2 style="text-align:center; font-size: 30px;">Neighbour Stats</br></h2>
                    <h4>Neighbours</h4>
                        <nav  style="overflow-y:scroll; max-height:1000px;">
                            <ul id="neighbours" style="text-align:left;"></ul>
                        </nav>
            </td>
        </tr>
        <tr>
            <td>
                Testing where this goes
            </td>
        </tr>
    </table>

</body>

</html>
