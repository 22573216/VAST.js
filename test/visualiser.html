<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

    <script type="text/javascript" src="../lib/voronoi/point2d.js"></script>
    <script type="text/javascript" src="../lib/voronoi/segment.js"></script>
    <script type="text/javascript" src="../lib/voronoi/line2d.js"></script>
    <script type="text/javascript" src="../lib/rhill-voronoi-core-min.js"></script>
    <script type="text/javascript" src="../lib/common/logger.js"></script>
    <script type="text/javascript" src="../lib/voronoi/vast_voro.js"></script>
    <script type="text/javascript" src="../lib/visualiser.js"></script>
    <script src="../lib/net/socket.io.js"></script>


    <script type="text/javascript">
        var _id = -1;
        var Visualiser = {
            visualiser : new Visualiser(),
            voronoi: new VAST_Voronoi(),
            gateway: {host: "127.0.0.1", port: 37700},
            aoi  : {x: 0, y: 0, aoi: 10},
            sites: [],
            neighbours: [],
            halt: undefined,
            diagram: null,
            margin: 50,
            canvas: null,
            bbox: {xl:0,xr:1000,yt:0,yb:1000},

            init: function(port) {
                sites = [];
                neighbours = [];
                this.canvas = document.getElementById("voronoiCanvas");
                console.log("init");
                this.voronoi.set_bounding_box(this.bbox);
                this.setID();
            },

            switchPort: function(port){
                this.visualiser.close();
                sites = [];
                neighbours = [];

                // clear incoming and outgoing messages
                document.getElementById("outgoing").innerHTML = "";
                document.getElementById("incoming").innerHTML = "";
                /*
                messages = this.visualiser.get_messages();

                do {} while (messages != undefined);

                console.log(messages);

                // repopulate message list with whatever messages have already been sent
                for (var i=0; i<messages.length; i++) {
                    this.appendList(messages[i]);
                }
                */

                console.log("Switching to port: "+port);
                this.visualiser.init(port, function(site_data, neighbour_data, halt) {
                    this.sites = site_data;
                    this.neighbours = neighbour_data;
                    this.halt = halt;

                    /*
                    console.log("Html sites:");
                    console.log(this.sites);
                    console.log(Object.keys(this.sites).length);

                    console.log("Html neighbours:");
                    console.log(this.neighbours);
                    console.log("Neighbour length: "+Object.keys(this.neighbours).length);
                    */

                    Visualiser.recalculate();
                }, function(direction,type,data) {
                    Visualiser.updateMessage(direction,type,data);
                }, function(bool) {
                    Visualiser.updateIndicator(bool);
                });
            },

            initVoro: function() {
                //console.log("Sites in initVoro");
                //console.log(sites);
                this.recalculate();
            },

            setID: function() {
                this.visualiser.set_onID(function(id) {
                    _id = id;
                    document.getElementById("selected").innerHTML = _id;
                });
            },

            updateMessage: function(type,data) {
                //console.log(data);
                //console.log("Updating message in the "+data.direction+" direction with "+data.name+" message");
                if (type < 8) {
                    this.appendList(data);
                }
            },

            // Indicator shows whether there are still messages to process or not
            updateIndicator: function(data){
                var ctx = this.canvas.getContext("2d");
                ctx.beginPath();
                if (data) {
                    ctx.fillStyle="red";
                } else {
                    ctx.fillStyle="green";
                }
                ctx.rect(0,0,10,10);
                ctx.fill();
            },

            appendList: function(data){
                var node = document.createElement("LI");
                var sender = data.msg.aid != undefined ? data.msg.aid : data.sender;
                var textnode = document.createTextNode("["+sender+"] "+data.name+" to targets "+data.targets);

                node.appendChild(textnode);
                document.getElementById(data.direction).appendChild(node);
            },

            recalculate: function() {
                //console.log("recalculate sites:");
                //console.log(sites);
                this.sites2voro();
                //console.log("after sites2voro:");
                //console.log(sites);
                this.diagram = this.voronoi.get_result();
                //console.log("after get_result:");
                //console.log(sites);
                this.updateStats();
                this.render();
            },

            sites2voro: function() {
                this.voronoi.clear();
                for (var key in sites) {
                    //console.log(sites[key]);
                    this.voronoi.insert(key,sites[key]);
                }
            },

            updateDiagram: function(){
                this.voronoi.set_bounding_box(this.bbox);
                this.diagram = this.voronoi.get_result();
            },

            next: function(bool) {
                this.visualiser.next(bool);
            },

            updateStats: function(){
                if (!this.diagram) {return;}
                var e = document.getElementById('voronoiStats');
                if (!e) {return;}
        		e.innerHTML = '('+this.diagram.cells.length+' Voronoi cells computed from '+Object.keys(sites).length+' Voronoi sites in '+this.diagram.execTime+' ms &ndash; rendering <i>not</i> included)';
            },

            render: function() {
                var ctx = this.canvas.getContext('2d');

                //clear sites and neighbours list
                var site_list = document.getElementById("sites");
                var neighbour_list = document.getElementById("neighbours");

                site_list.innerHTML = "";
                neighbour_list.innerHTML = "";

                //background
                ctx.globalAlpha = 1;
                ctx.beginPath();
                ctx.rect(0,0,this.canvas.width,this.canvas.height);
        		ctx.fillStyle = 'white';
        		ctx.fill();
        		ctx.strokeStyle = '#888';
                ctx.lineWidth = 1;
        		ctx.stroke();

        		// voronoi
                if (!this.diagram) {return;}

                // debug mode indicator
                ctx.fillStyle = halt ? "green" : "red";

                ctx.beginPath();
                ctx.rect(this.canvas.width-10, 0, 10, 10);
                ctx.fill();

        		// edges
        		ctx.beginPath();
        		ctx.strokeStyle='#000';

        		var edges = this.diagram.edges,
        			iEdge = edges.length,
        			edge, v;
        		while (iEdge--) {
        			edge = edges[iEdge];
        			v = edge.va;
                    // NOTE: multiply by 8
        			ctx.moveTo(v.x,v.y);
        			v = edge.vb;
        			ctx.lineTo(v.x,v.y);
        			}
        		ctx.stroke();

                // sites
        		ctx.beginPath();
                ctx.fillStyle = '#44f';
                ctx.font = "15px Verdana";

                for (var key in sites) {
                    v = sites[key];
                    var idx = v.id;

                    // NOTE: Multiply by 8
                    ctx.rect(v.x,v.y,4,4);
                    ctx.fillText(idx, v.x+7,v.y+7);

                    // add site to info on right
                    var node = document.createElement("LI");
                    var textnode = document.createTextNode("["+idx+"] Site: ("+Math.round(v.x)+","+Math.round(v.y)+") voronoiID: "+v.voronoiId);

                    node.appendChild(textnode);
                    site_list.appendChild(node);
                }

                ctx.fill();

                //fill neighbour list and draw AoI
                for (var key in neighbours) {
                    v = neighbours[key];
                    idx = v.id;

                    if (idx == _id) {
                        ctx.beginPath();
    					ctx.strokeStyle='#000';
                        ctx.lineWidth = 1;

                        // NOTE: multiply by 8
                        ctx.arc(v.aoi.center.x, v.aoi.center.y, v.aoi.radius, 0, Math.PI*2, true);
                        ctx.stroke();
                    }

                    node = document.createElement("LI");
                    textnode = document.createTextNode("["+v.id+"] Site: ("+Math.round(v.aoi.center.x)+","+Math.round(v.aoi.center.y)+") voronoiID: "+v.aoi.center.voronoiId);

                    node.appendChild(textnode);
                    neighbour_list.appendChild(node);
                }
            },
            getVoro: function() {
                return this.voronoi;
            }
        };

        Element.prototype.leftTopScreen = function () {
            var x = 0;
            var y = 0;

            return new Array (x, y);
        }

        var curr_id = 0;
        document.addEventListener ("DOMContentLoaded", function () {
            var canvas = document.getElementById ("voronoiCanvas");

            var mouse_x = document.getElementById ("mouse_x");
            var mouse_y = document.getElementById ("mouse_y");

            var xy = canvas.leftTopScreen();

            canvas.addEventListener ("click", function (event) {
                var x,y;

                if (event.offsetX) {
                    x = event.offsetX;
                    y = event.offsetY;
                }
                else if (event.layerX) {
                    x = event.layerX;
                    y = event.layerY;
                }

                // get adjusted x & y coordinates
                x = x - xy[0];
                y = y - xy[1];
                console.log("x:"+x+" y:"+y);

                // display coordinates
                mouse_x.value = x;
                mouse_y.value = y;

                var voro = Visualiser.getVoro();
                var result = voro.get_result();

                // draw all edges for a region given it's site id
                var drawEdges = function (id, color_style) {

                    var idx = voro.getidx(id);
                    var halfedges = result.cells[idx].halfedges;

                    var edges = [];
                    for(var j=0; j < halfedges.length; j++)
                        edges.push(halfedges[j].edge);

                    // draw new enclosing neighbors
    				// draw edges of enclosing neighbors
    				context.beginPath();
                    context.strokeStyle = color_style;
                    context.lineWidth = 3;

    				var	iEdge = edges.length,
    					edge, v;
    				while (iEdge--) {
    					edge = edges[iEdge];
    					v = edge.va;
    					context.moveTo(v.x,v.y);
    					v = edge.vb;
    					context.lineTo(v.x,v.y);
    					}
    				context.stroke();
                }

                Visualiser.visualiser.move(x,y,aoi_radius.value);
            })
        });
    </script>
</head>

<body onload="Visualiser.init();">
    <table width="100%" border=0>
        <tr>
            <td>
                <h1>VAST gateway and client visualiser</h1>
                <div id="divroot" style="width:800px;">

                <h4 class="divhdr">Client selected: <span id="selected" style="font: bold 20px sans;"></span></h4>
                <div class="divinfo" id="voronoiGenerator">
                <input type="button" value="Select port" onclick="Visualiser.switchPort(document.getElementById('port').value);"/> <input id="port" type="text" value="8888" size="4" maxlength="5"/><input id="next" type="button" value="Next command" onclick="Visualiser.next(true);"><input id="halt" type="button" value="Run normally" onclick="Visualiser.next(false);">
                <br/>
                mouse_x:
                <input id="mouse_x" type="text" value="100" size="5" maxlength="5"/>
                mouse_y:
                <input id="mouse_y" type="text" value="100" size="5" maxlength="5"/>
                AOI radius:
                <input id="aoi_radius" type="text" value="10" size="5" maxlength="5"/>
                <br />
                <form id="disp_form">
                Display Type:
                <input type="radio" name="disp_type" value="enclosing" checked="true"/>enclosing &nbsp &nbsp
                <input type="radio" name="disp_type" value="boundary" /> boundary
                </form>
                </div>

            </td>
        </tr>
        <tr max-height="840px">
            <td width = "50%">
                <h4 class="divhdr">Canvas <span id="voronoiStats" style="font:normal 11px sans"></span></h4>
                <div id="canvasParent">
                    <noscript>You need to enable Javascript in your browser for this page to display properly.</noscript>
                    <canvas id="voronoiCanvas" width="1000" height="1000" onclick=""></canvas>
                </div>
            </td>
            <td width = "50%" valign="top">
                <h2 style="text-align:center; font-size: 30px;">Neighbour Stats</br></h2>
                <table width="100%" border = 0 style="text-align:center;">
                    <tr>
                        <td width="50%">
                            <h4>Sites</h4>
                            <ul id="sites" style="text-align:left;"></ul>
                        </td>
                        <td width="50%">
                            <h4>Neighbours</h4>
                            <ul id="neighbours" style="text-align:left;"></ul>
                        </td>
                    </tr>
                    <tr style="text-align:center;">
                        <td colspan="2">
                            <h2 style="text-align:center; font-size:30px;">Messages</h2>
                        </td>
                    </tr>
                    <tr>
                        <td width="50%">
                            <nav  style="overflow-y:scroll; max-height:560px;">
                                <h4>Outgoing</h4>
                                <ul id="outgoing" style="text-align:left;"></ul>
                            </nav>
                        </td>
                        <td width="50%">
                            <nav  style="overflow-y:scroll; max-height:560px;">
                                <h4>Incoming</h4>
                                <ul id="incoming" style="text-align:left;"></ul>
                            </nav>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

</body>

</html>
